---
layout: post
title: "注解和元编程"
date: 2024-11-11 12:28:18 +0800
categories: Notes
---

# 注解和元编程

任何有过 Java 开发经验的开发者都会频繁且重度使用注解。注解本身是代码的一部分，但它同时也在注解源码以实现某种特定的功能，是比源码更高一级的抽象。

如果你有其他语言的开发经验，则很容易找到其他语言中拥有相似功能的机制。比如 python/typescript 中的 decorator，Rust 中的属性 (Attributes) 等。

事实上，如果我们尝试溯源各种语言的设计，可以发现大多数注解和类似注解的机制，本质上是为了尝试某种程度的元编程 ([Meta Programming](https://en.wikipedia.org/wiki/Metaprogramming))。本文从 Java 的注解机制开始，探讨元编程思想在 Java 语言中的体现和应用，以及对我们实际的编码开发的意义。

## 可变的源码

编程语言本身是面向人类的人机接口，是程序开发者的人类的思想到计算机能识别的机器码之间的一层用文字表达的抽象。
基于传统的面向过程的指令型编程语言，我们可以简单地将编程语言的抽象分为两个方面：

- 变量，常量，数据结构等基本的数据抽象，它们对应的是对于计算机内存（包括虚拟内存）中数据的抽象，我们可以将数据存储在内存中，通过变量名来引用这些数据，通过数据结构来组织这些数据。
- 函数，方法，类等基本的逻辑抽象，它们对应的是对于计算机执行逻辑的抽象，我们可以将一段逻辑封装在函数中，通过函数名来引用这段逻辑，通过类来组织这些函数。执行逻辑可以操作数据，可以改变数据的状态，可以调用其他逻辑。

然而，我们知道可执行程序的所有内容本质上都是内存中的数据，因此如果我们的编程语言可以操作这些数据，那么我们就可以通过编程语言来操作程序的执行逻辑。实际上，大多数现代编程语言中，函数本身就是一种数据，可以作为参数传递，可以作为返回值返回，可以在运行时动态生成，这种思想起源于函数式编程语言中，但目前的大多数编程语言都是多范式的，因此我们也能看到这种思想在其他范式的编程语言中的体现：

- C/C++ 中的函数指针或者`std::function`类型，在C/C++中，函数是一等公民，可以作为参数传递，可以作为返回值返回，可以在运行时动态生成。
- Golang 中的`func`类型，Golang 中的函数也是一种类型，可以作为参数传递，可以作为返回值返回，可以在运行时动态生成。
- Python/Javascript/Ruby 等一系列的脚本语言也都支持函数的传入传出。
- Java 8 之后的方法引用也部分地实现了函数作为一种参数输入。

那么，让我们再进一步，既然可以通过在运行时动态地组合各类函数以改变程序的执行行为，那么可不可以直接通过修改程序的源码来改变其执行行为呢？毕竟程序的所有部分本质上都只是内存上的一块数据而已。

元编程就是尝试将这种抽象提升到更高的层次，**让程序员可以通过代码来操作代码，通过代码来生成代码，通过代码来改变代码的执行逻辑**。这种能力不仅提升了开发者的灵活性，还为构建复杂系统提供了更加有力的工具。

元编程的实际应用并不复杂，如果你有过 C/C++ 的开发经验，应该对宏(Macro)的概念并不陌生。在编译过程中，宏的替换发生在词法分析之前，宏展开之后的产物依然是文本，是有一定可读性的源码。本质上就是在编译器生成源码。

在 Java 语言中，虽然不存在像C这样简单的宏替换，但我们依然有办法在编译甚至运行时修改源码和字节码的内容。我们可能会想到反射机制和利用反射机制的[Java ASM](https://asm.ow2.io/)，[bytebuddy](https://bytebuddy.net/#/)等，我们先不去深入这些工具的细节。先从一个最基本的问题入手，**如何让编译器和JAVA虚拟机理解我们想如何更改源码**。

回到 C/C++ 的例子，在这个例子中，我们通过宏来告诉编译器我们想要替换的内容，编译器在编译时会将宏展开，生成新的源码。从这个角度来讲，宏描述了我们修改代码的意图，指导编译器理解和修改源码。而在 Java 中，我们可以通过注解来实现类似的功能。

## 注解：帮助编译器理解源码

注解是 [Java 5 中引入的机制](https://docs.oracle.com/javase/1.5.0/docs/guide/language/annotations.html)，设计的本意是避免用户书写太多样板代码(boilerplate code)，比如网络请求的路由处理、字段校验、序列/反序列化等等，这些步骤包括很多重复的逻辑，没有必要让用户以指令型编程语句反复编写，我们希望用户可能只是在某些字段、方法、类上以某种简洁的方式标记此段代码逻辑，编译器/解析器就能够识别这些简单的逻辑并生成相似的逻辑，并采取某些措施以实现某些特定的目的，比如在编译阶段进行代码扫描、代码生成，在运行时识别有某些特殊标记的源码以更改其执行逻辑等等。

上述的例子中，我们可以看到注解的作用是告诉编译器我们想要做的事情，编译器在编译时会扫描源码，识别这些注解，然后根据注解的内容生成新的代码。这种机制使得我们可以在编译时动态地生成代码，实现一些复杂的逻辑。如果说代码中的注释是帮助开发者理解源码的信息，那么注解就是帮助编译器和运行时理解代码的信息。

我们还是通过实际的例子来看看注解的使用，以及它是如何帮助编译器和运行时理解源码的。

### 编译期的注解

上文说过，Java中不存在像C这样简单的宏替换，但我Java为我们提供了注解处理器(Annotation Processor)的机制，我们可以通过注解处理器来实现类似的功能。注解处理器是一个在编译时运行的工具，它可以扫描源码中的注解，然后根据注解的内容生成新的代码。

### 运行时的注解

相对于编译期的注解，可能大多数Java开发者更熟悉的是运行时的注解。因为运行时的注解可以充分利用Java的反射机制，实现如DI、AOP等更复杂的功能。

如果你使用过较新版本的Spring框架，那么你应该对`@Autowired`、`@Component`、`@RequestMapping`等注解不陌生。这些注解的作用是告诉Spring框架如何处理这些类和方法，Spring框架在启动时会扫描所有的类和方法，识别这些注解，然后根据注解的内容生成新的代码，实现依赖注入、路由处理等功能。



